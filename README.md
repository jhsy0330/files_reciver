# 文件接收系统 (Files Reciver)

一个基于 Flask 的简单文件接收系统，支持密码验证和文件上传功能。

## 功能特点

- 密码验证机制，确保只有授权用户才能上传文件
- 支持批量文件上传
- 自动处理文件名冲突
- 限制文件类型，确保安全性
- 支持大文件上传（默认10GB限制）
- 自动生成安全的 SECRET_KEY
- 配置文件独立管理，便于维护
- **基于IP和日期的文件隔离**：每个IP只能查看当天上传的文件
- **自定义上传路径**：支持配置文件存储位置
- **实时上传速度显示**：显示当前上传速度和预计剩余时间
- **断点续传功能**：支持网络中断后继续上传，避免重复上传
- **文件压缩上传**：支持上传前压缩文件，节省带宽和存储空间

## 技术栈

- Python 3.6+
- Flask
- JSON 配置

## 安装方法

1. 克隆或下载项目代码到本地：

```bash
git clone <repository-url>
cd files_reciver
```

2. 安装依赖（如果需要）：

```bash
pip install flask
```

## 使用说明

1. 配置文件

项目使用 `config.json` 进行配置，首次运行时会自动生成 `SECRET_KEY`：

```json
{
    "SECRET_KEY": "随机生成的安全密钥",
    "PASSWORD": "123456",
    "UPLOAD_FOLDER": "uploads",
    "UPLOAD_PATH": "",
    "ALLOWED_EXTENSIONS": ["txt", "pdf", "png", "jpg", "jpeg", "gif", "doc", "docx", "xls", "xlsx", "ppt", "pptx", "zip", "rar", "tar", "gz", "7z"],
    "MAX_CONTENT_LENGTH": 10737418240
}
```

2. 启动服务

```bash
python app.py
```

服务将在 `http://0.0.0.0:8080` 启动。

3. 访问系统

- 打开浏览器，访问 `http://localhost:8080`
- 输入密码（默认：123456）
- 进入文件上传页面，选择并上传文件

## 配置选项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| SECRET_KEY | Flask 应用的安全密钥，用于加密 session 数据 | 自动生成 |
| PASSWORD | 访问文件上传页面的密码 | 123456 |
| UPLOAD_FOLDER | 文件上传的相对目录 | uploads |
| UPLOAD_PATH | 文件上传的绝对路径（优先级高于UPLOAD_FOLDER） | 空 |
| RECEIVER_NAME | 接收方名称，显示在页面标题中 | 文件接收系统 |
| MAX_UPLOAD_FOLDER_SIZE | 上传文件夹最大大小限制（字节） | 100GB (107374182400) |
| ALLOWED_EXTENSIONS | 允许上传的文件类型列表 | txt, pdf, png, jpg, jpeg, gif, doc, docx, xls, xlsx, ppt, pptx, zip, rar, tar, gz, 7z |
| MAX_CONTENT_LENGTH | 最大文件上传大小限制（字节） | 10GB (10737418240) |
| CHUNK_SIZE | 分块上传的块大小（字节） | 5MB (5242880) |
| COMPRESSION_LEVEL | 文件压缩级别（0-9，0不压缩，9最大压缩） | 6 |

## 文件隔离机制

系统采用基于IP和日期的文件隔离机制：

- **文件命名格式**：`IP_日期_原始文件名`
  - 示例：`192.168.1.100_2024-01-15_document.pdf`
- **访问控制**：每个IP只能查看当天上传的文件
- **自动清理**：0点后刷新页面，不会看到前一天的文件

## 新功能说明

### 1. 实时上传速度显示

系统会实时显示文件上传的速度和预计剩余时间：

- **显示内容**：
  - 当前上传速度（如：2.5 MB/s）
  - 已上传进度（如：50%）
  - 已上传大小（如：50 MB / 100 MB）
  - 预计剩余时间（如：20秒）
- **更新频率**：每秒更新一次
- **自动计算**：根据已上传字节数和上传时间自动计算速度

### 2. 断点续传功能

支持网络中断后继续上传，避免重复上传：

- **工作原理**：
  - 文件被分成多个块（默认5MB）上传
  - 每个块上传成功后会记录状态
  - 如果上传中断，可以从中断的位置继续上传
- **使用方法**：
  - 上传过程中如果网络中断，点击"继续上传"按钮
  - 系统会自动检查已上传的块，从断点继续上传
  - 也可以点击"取消上传"按钮取消当前上传任务
- **技术实现**：
  - 前端：使用 `uploadFileInChunks` 函数分块上传
  - 后端：使用临时文件存储已上传的块
  - 状态管理：使用 `status.json` 文件记录上传状态
- **优势**：
  - 节省带宽和时间
  - 提高大文件上传的可靠性
  - 支持网络不稳定的环境

### 3. 文件压缩上传

支持上传前压缩文件，节省带宽和存储空间：

- **工作原理**：
  - 使用 gzip 压缩算法压缩文件
  - 压缩级别可配置（0-9，默认6）
  - 压缩后的文件上传到服务器后自动解压
- **使用方法**：
  - 在上传页面勾选"上传前压缩文件"复选框
  - 选择文件后点击上传
  - 系统会先压缩文件，然后上传
  - 上传完成后自动解压到服务器
- **压缩效果**：
  - 文本文件：通常可压缩 60-80%
  - 图片文件：压缩效果有限（5-20%）
  - 视频文件：压缩效果有限（0-10%）
  - 已压缩文件：几乎无效果
- **技术实现**：
  - 前端：使用 pako.js 库进行 gzip 压缩
  - 后端：使用 Python gzip 模块解压
  - 自动清理：解压完成后自动删除压缩文件
- **注意事项**：
  - 压缩会增加上传前的处理时间
  - 对于已经压缩的文件（如 .zip, .jpg, .mp4），压缩效果有限
  - 压缩级别越高，压缩率越高，但处理时间越长

## 文件夹大小限制

系统支持设置上传文件夹的最大大小限制，防止文件夹过大撑爆硬盘：

- **配置项**：`MAX_UPLOAD_FOLDER_SIZE`
- **默认值**：100GB (107374182400 字节)
- **检查时机**：每次上传文件前
- **限制规则**：当前文件夹大小 + 即将上传的文件大小 ≤ MAX_UPLOAD_FOLDER_SIZE
- **超出限制**：会显示错误提示，拒绝上传并提示当前文件夹大小、即将上传大小和限制大小

**示例错误提示**：
```
上传失败！当前文件夹大小为 95.50 GB，即将上传 8.00 GB，总大小将超过限制 100.00 GB。请联系管理员清理空间。
```

## 注意事项

1. 首次运行时，系统会自动生成 `SECRET_KEY` 并保存到 `config.json` 文件中
2. 请在生产环境中修改默认密码，确保安全性
3. 上传的文件将保存在 `uploads` 目录下或指定的 `UPLOAD_PATH` 路径
4. 如果上传目录不存在，系统会自动创建
5. 请勿将 `config.json` 文件提交到版本控制系统中，尤其是包含敏感信息时
6. 文件名格式为 `IP_日期_原始文件名`，便于管理和隔离

## 自定义配置

可以根据需要修改 `config.json` 文件中的配置项：

- 修改密码：
  ```json
  "PASSWORD": "your-new-password"
  ```

- 设置自定义接收方名称：
  ```json
  "RECEIVER_NAME": "张三"
  ```
  页面将显示"向张三发送文件"

- 设置上传文件夹大小限制：
  ```json
  "MAX_UPLOAD_FOLDER_SIZE": 214748364800  // 200GB
  ```
  常用大小参考：
  - 50GB: 53687091200
  - 100GB: 107374182400
  - 200GB: 214748364800
  - 500GB: 536870912000
  - 1TB: 1099511627776

- 设置自定义上传路径（绝对路径）：
  ```json
  "UPLOAD_PATH": "/path/to/your/upload/directory"
  ```

- 设置自定义上传路径（相对路径）：
  ```json
  "UPLOAD_PATH": "custom_uploads"
  ```

- 添加允许的文件类型：
  ```json
  "ALLOWED_EXTENSIONS": ["txt", "pdf", "png", "jpg", "jpeg", "gif", "doc", "docx", "xls", "xlsx", "ppt", "pptx", "zip", "rar", "tar", "gz", "7z", "mp4"]
  ```

- 增加或减少上传大小限制：
  ```json
  "MAX_CONTENT_LENGTH": 21474836480  // 20GB
  ```

- 设置分块上传的块大小：
  ```json
  "CHUNK_SIZE": 10485760  // 10MB
  ```
  常用大小参考：
  - 1MB: 1048576
  - 5MB: 5242880（默认）
  - 10MB: 10485760
  - 20MB: 20971520
  - 50MB: 52428800

- 设置文件压缩级别：
  ```json
  "COMPRESSION_LEVEL": 9  // 最大压缩
  ```
  压缩级别说明：
  - 0: 不压缩
  - 1-3: 快速压缩，压缩率较低
  - 4-6: 平衡压缩率和速度（默认6）
  - 7-9: 最大压缩率，但速度较慢

## 安全性建议

1. 定期更新 `SECRET_KEY`
2. 使用强密码
3. 根据实际需求调整允许的文件类型
4. 在生产环境中禁用 debug 模式
5. 考虑使用 HTTPS 协议
6. 定期清理旧文件，避免磁盘空间不足

## 许可证

MIT License
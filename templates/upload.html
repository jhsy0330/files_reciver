<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñá‰ª∂‰∏ä‰º†Á≥ªÁªü - ‰∏ä‰º†Êñá‰ª∂</title>
    <!-- ÂºïÂÖ•pakoÂ∫ìÁî®‰∫éÂéãÁº© -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 600px;
            max-width: 100%;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .flash {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .success {
            background-color: #4CAF50;
            color: white;
        }
        .error {
            background-color: #f44336;
            color: white;
        }
        .info {
            background-color: #2196F3;
            color: white;
        }
        /* ÊãñÊãΩ‰∏ä‰º†Âå∫ÂüüÊ†∑Âºè */
        .drop-zone {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .drop-zone:hover {
            background-color: #f0f0f0;
            border-color: #45a049;
        }
        .drop-zone.drag-over {
            background-color: #e8f5e9;
            border-color: #2e7d32;
            transform: scale(1.02);
        }
        .drop-zone-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .drop-zone-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .drop-zone-hint {
            color: #999;
            font-size: 14px;
        }
        /* ÈÄâ‰∏≠ÁöÑÊñá‰ª∂È¢ÑËßà */
        .selected-files {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            display: none;
        }
        .selected-files.show {
            display: block;
        }
        .selected-files-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .selected-file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid #eee;
        }
        .selected-file-icon {
            font-size: 24px;
            margin-right: 10px;
            color: #4CAF50;
        }
        .selected-file-info {
            flex-grow: 1;
        }
        .selected-file-name {
            font-size: 14px;
            color: #333;
            margin-bottom: 2px;
        }
        .selected-file-size {
            font-size: 12px;
            color: #999;
        }
        .selected-file-remove {
            color: #f44336;
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
            transition: color 0.2s;
        }
        .selected-file-remove:hover {
            color: #d32f2f;
        }
        /* ÈöêËóèÂéüÂßãÊñá‰ª∂ËæìÂÖ•Ê°Ü */
        #file {
            display: none;
        }
        /* ËøõÂ∫¶Êù°Ê†∑Âºè */
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            overflow: hidden;
            display: none;
            margin-bottom: 15px;
        }
        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            color: #666;
            margin-top: 5px;
            font-size: 14px;
        }
        /* Â∑≤‰∏ä‰º†Êñá‰ª∂ÂàóË°®Ê†∑Âºè */
        .files-section {
            margin-top: 30px;
        }
        .files-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .file-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-info {
            flex-grow: 1;
        }
        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }
        .file-meta {
            font-size: 12px;
            color: #666;
        }
        .no-files {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Âêë{{ receiver_name }}ÂèëÈÄÅÊñá‰ª∂</h1>
        {% with messages = get_flashed_messages() %} 
          {% if messages %} 
            {% for message in messages %} 
              {% if 'ÊàêÂäü' in message %} 
                <div class="flash success">{{ message }}</div> 
              {% elif 'ÈîôËØØ' in message or 'Ê≤°Êúâ' in message or '‰∏çÂÖÅËÆ∏' in message or 'ËØ∑ÂÖà' in message %} 
                <div class="flash error">{{ message }}</div> 
              {% else %} 
                <div class="flash info">{{ message }}</div> 
              {% endif %} 
            {% endfor %} 
          {% endif %} 
        {% endwith %} 
        <form id="uploadForm" method="post" enctype="multipart/form-data">
            <!-- ÊãñÊãΩ‰∏ä‰º†Âå∫Âüü -->
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">üìÅ</div>
                <div class="drop-zone-text">ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ‰∏ä‰º†</div>
                <div class="drop-zone-hint">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÔºàÊîØÊåÅÂ§öÊñá‰ª∂Ôºâ</div>
            </div>
            
            <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
            <input type="file" id="file" name="file" multiple>
            
            <!-- ÈÄâ‰∏≠ÁöÑÊñá‰ª∂È¢ÑËßà -->
            <div class="selected-files" id="selectedFiles">
                <div class="selected-files-title">Â∑≤ÈÄâÊã© <span id="fileCount">0</span> ‰∏™Êñá‰ª∂</div>
                <div id="selectedFileList"></div>
            </div>
            
            <!-- ËøõÂ∫¶Êù° -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="progress-text" id="progressText"></div>
            
            <!-- ÂéãÁº©ÈÄâÈ°π -->
            <div class="form-group">
                <label>
                    <input type="checkbox" id="compressCheckbox"> 
                    ‰∏ä‰º†ÂâçÂéãÁº©Êñá‰ª∂ÔºàÂèØËäÇÁúÅÂ∏¶ÂÆΩÔºå‰ΩÜ‰ºöÂ¢ûÂä†Â§ÑÁêÜÊó∂Èó¥Ôºâ
                </label>
            </div>
            
            <button type="submit" id="uploadBtn">‰∏ä‰º†</button>
            <button type="button" id="resumeBtn" style="display: none; background-color: #2196F3;">ÁªßÁª≠‰∏ä‰º†</button>
            <button type="button" id="cancelBtn" style="display: none; background-color: #f44336;">ÂèñÊ∂à‰∏ä‰º†</button>
        </form>
        
        <!-- Â∑≤‰∏ä‰º†Êñá‰ª∂ÂàóË°® -->
        <div class="files-section">
            <h2>Â∑≤‰∏ä‰º†Êñá‰ª∂</h2>
            {% if uploaded_files %} 
                <ul class="file-list">
                    {% for file in uploaded_files %} 
                        <li class="file-item">
                            <div class="file-info">
                                <div class="file-name">{{ file.name }}</div>
                                <div class="file-meta">
                                    Â§ßÂ∞èÔºö{{ "%.2f"|format(file.size / 1024 / 1024) }} MB ‚Ä¢ 
                                    ‰∏ä‰º†Êó∂Èó¥Ôºö{{ file.time|datetimeformat }}
                                </div>
                            </div>
                        </li> 
                    {% endfor %} 
                </ul>
            {% else %} 
                <div class="no-files">ÊöÇÊó†Â∑≤‰∏ä‰º†ÁöÑÊñá‰ª∂</div>
            {% endif %} 
        </div>
    </div>

    <script>
        // Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
        let selectedFiles = [];
        
        // Â≠òÂÇ®‰∏ä‰º†Áä∂ÊÄÅ
        let uploadStates = {}; // Â≠òÂÇ®ÊØè‰∏™Êñá‰ª∂ÁöÑ‰∏ä‰º†Áä∂ÊÄÅ
        let currentUpload = null; // ÂΩìÂâç‰∏ä‰º†‰ªªÂä°
        let isPaused = false; // ÊòØÂê¶ÊöÇÂÅú
        let isCancelled = false; // ÊòØÂê¶ÂèñÊ∂à
        
        // ÂàÜÂùóÂ§ßÂ∞èÈÖçÁΩÆÔºà5MBÔºâ
        const CHUNK_SIZE = 5 * 1024 * 1024;
        
        // Ëé∑ÂèñDOMÂÖÉÁ¥†
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('file');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const selectedFileList = document.getElementById('selectedFileList');
        const fileCount = document.getElementById('fileCount');
        const uploadBtn = document.getElementById('uploadBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        // ÁÇπÂáªÊãñÊãΩÂå∫ÂüüËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Êñá‰ª∂ÈÄâÊã©ÂèòÂåñÊó∂Êõ¥Êñ∞È¢ÑËßà
        fileInput.addEventListener('change', function() {
            const files = Array.from(fileInput.files);
            addFiles(files);
            fileInput.value = ''; // Ê∏ÖÁ©∫inputÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Áõ∏ÂêåÊñá‰ª∂
        });
        
        // ÊãñÊãΩ‰∫ã‰ª∂Â§ÑÁêÜ
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                addFiles(files);
            }
        });
        
        // Ê∑ªÂä†Êñá‰ª∂Âà∞ÂàóË°®
        function addFiles(files) {
            files.forEach(file => {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÊñá‰ª∂
                const exists = selectedFiles.some(f => 
                    f.name === file.name && f.size === file.size && f.type === file.type
                );
                if (!exists) {
                    selectedFiles.push(file);
                }
            });
            updateFilePreview();
        }
        
        // Êõ¥Êñ∞Êñá‰ª∂È¢ÑËßà
        function updateFilePreview() {
            selectedFileList.innerHTML = '';
            fileCount.textContent = selectedFiles.length;
            
            if (selectedFiles.length > 0) {
                selectedFilesDiv.classList.add('show');
                
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'selected-file-item';
                    fileItem.innerHTML = `
                        <div class="selected-file-icon">üìÑ</div>
                        <div class="selected-file-info">
                            <div class="selected-file-name">${file.name}</div>
                            <div class="selected-file-size">${formatBytes(file.size)}</div>
                        </div>
                        <div class="selected-file-remove" onclick="removeFile(${index})">√ó</div>
                    `;
                    selectedFileList.appendChild(fileItem);
                });
            } else {
                selectedFilesDiv.classList.remove('show');
            }
        }
        
        // ÁßªÈô§Êñá‰ª∂
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }
        
        // Ê†ºÂºèÂåñÂ≠óËäÇÊï∞
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥ÔºàÁßíÔºâ‰∏∫ÂèØËØªÊ†ºÂºè
        function formatTime(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}Áßí`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${minutes}ÂàÜ${secs}Áßí`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}Â∞èÊó∂${minutes}ÂàÜ`;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥Êà≥‰∏∫ÂèØËØªÊó∂Èó¥
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // ÁîüÊàêÊñá‰ª∂IDÔºàÂü∫‰∫éÊñá‰ª∂ÂêçÂíåÂ§ßÂ∞èÔºâ
        function generateFileId(file) {
            const content = file.name + file.size + file.type;
            let hash = 0;
            for (let i = 0; i < content.length; i++) {
                const char = content.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // ËΩ¨Êç¢‰∏∫32‰ΩçÊï¥Êï∞
            }
            return Math.abs(hash).toString(16);
        }
        
        // Ê£ÄÊü•Êñá‰ª∂‰∏ä‰º†Áä∂ÊÄÅ
        async function checkUploadStatus(fileId) {
            try {
                const formData = new FormData();
                formData.append('file_id', fileId);
                
                const response = await fetch('/upload/check', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                return data.uploaded_size || 0;
            } catch (error) {
                console.error('Ê£ÄÊü•‰∏ä‰º†Áä∂ÊÄÅÂ§±Ë¥•:', error);
                return 0;
            }
        }
        
        // ÂéãÁº©Êñá‰ª∂
        async function compressFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // ‰ΩøÁî®gzipÂéãÁº©ÔºåÂéãÁº©Á∫ßÂà´‰∏∫6ÔºàÂπ≥Ë°°ÈÄüÂ∫¶ÂíåÂéãÁº©ÁéáÔºâ
                        const compressed = pako.gzip(data, { level: 6 });
                        const compressedBlob = new Blob([compressed], { type: 'application/gzip' });
                        resolve(compressedBlob);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ‰∏ä‰º†Êñá‰ª∂Âùó
        async function uploadChunk(originalFile, compressedFile, fileId, chunk, chunkIndex, totalChunks, onProgress, isCompressed) {
            // Ê†πÊçÆÊòØÂê¶ÂéãÁº©ÈÄâÊã©Ê≠£Á°ÆÁöÑÊñá‰ª∂Â§ßÂ∞è
            const fileToUse = isCompressed ? compressedFile : originalFile;
            
            const formData = new FormData();
            formData.append('file_id', fileId);
            formData.append('chunk', chunk);
            formData.append('chunk_index', chunkIndex);
            formData.append('total_chunks', totalChunks);
            formData.append('filename', originalFile.name);
            formData.append('filesize', originalFile.size);
            formData.append('is_compressed', isCompressed);
            
            const response = await fetch('/upload/chunk', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('‰∏ä‰º†ÂùóÂ§±Ë¥•');
            }
            
            const data = await response.json();
            if (data.success) {
                // ‰º†ÈÄíÂΩìÂâçÂùóÁöÑÂ§ßÂ∞èÁªôËøõÂ∫¶ÂõûË∞É,‰ΩøÁî®Ê≠£Á°ÆÁöÑÊñá‰ª∂ÊÄªÂ§ßÂ∞è
                onProgress(chunk.size, fileToUse.size);
            } else {
                throw new Error(data.message || '‰∏ä‰º†ÂùóÂ§±Ë¥•');
            }
        }
        
        // ÁªßÁª≠‰∏ä‰º†
        async function resumeUpload() {
            if (!currentUpload || !currentUpload.file) {
                alert('Ê≤°ÊúâÂèØÁªßÁª≠ÁöÑ‰∏ä‰º†‰ªªÂä°');
                return;
            }
            
            const file = currentUpload.file;
            const fileId = currentUpload.fileId;
            
            // Ê£ÄÊü•Â∑≤‰∏ä‰º†ÁöÑÂ≠óËäÇÊï∞
            const uploadedBytes = await checkUploadStatus(fileId);
            
            if (uploadedBytes >= file.size) {
                alert('Êñá‰ª∂Â∑≤‰∏ä‰º†ÂÆåÊàê');
                resetUploadUI();
                return;
            }
            
            // ËÆ°ÁÆó‰ªéÂì™‰∏™ÂùóÂºÄÂßã‰∏ä‰º†
            const startChunkIndex = Math.floor(uploadedBytes / CHUNK_SIZE);
            
            isPaused = false;
            isCancelled = false;
            resumeBtn.style.display = 'none';
            cancelBtn.style.display = 'inline-block';
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‰∏ä‰º†‰∏≠...';
            
            // ‰ªéÊñ≠ÁÇπÁªßÁª≠‰∏ä‰º†
            uploadFileInChunks(file, fileId, startChunkIndex);
        }
        
        // ÂèñÊ∂à‰∏ä‰º†
        function cancelUpload() {
            if (currentUpload) {
                isCancelled = true;
                currentUpload = null;
            }
            resetUploadUI();
        }
        
        // ÈáçÁΩÆ‰∏ä‰º†UI
        function resetUploadUI() {
            uploadBtn.disabled = false;
            uploadBtn.textContent = '‰∏ä‰º†';
            resumeBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            isPaused = false;
            isCancelled = false;
            
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressText.textContent = '';
        }
        
        // Êõ¥Êñ∞ËøõÂ∫¶ÊñáÊú¨
        function updateProgressText(text) {
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = text;
            }
        }

        // Âä†ËΩΩÂ∑≤‰∏ä‰º†ÁöÑÊñá‰ª∂ÂàóË°®
        async function loadUploadedFiles() {
            try {
                // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•Âà∑Êñ∞Êñá‰ª∂ÂàóË°®
                window.location.reload();
            } catch (error) {
                console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
            }
        }
        
        // ÂàÜÂùó‰∏ä‰º†Êñá‰ª∂
        async function uploadFileInChunks(file, fileId, startChunkIndex = 0) {
            console.log('uploadFileInChunks Ë¢´Ë∞ÉÁî®', { file: file.name, fileId, startChunkIndex });
            
            const shouldCompress = document.getElementById('compressCheckbox').checked;
            let fileToUpload = file;
            
            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';
            
            // Â¶ÇÊûúÈúÄË¶ÅÂéãÁº©,ÂÖàÂéãÁº©Êñá‰ª∂
            if (shouldCompress) {
                try {
                    updateProgressText('Ê≠£Âú®ÂéãÁº©Êñá‰ª∂...');
                    fileToUpload = await compressFile(file);
                    const compressionRatio = ((1 - fileToUpload.size / file.size) * 100).toFixed(1);
                    updateProgressText(`ÂéãÁº©ÂÆåÊàê,ËäÇÁúÅ‰∫Ü ${compressionRatio}% ÁöÑÁ©∫Èó¥`);
                } catch (error) {
                    console.error('ÂéãÁº©Â§±Ë¥•:', error);
                    alert('Êñá‰ª∂ÂéãÁº©Â§±Ë¥•,Â∞Ü‰ΩøÁî®ÂéüÂßãÊñá‰ª∂‰∏ä‰º†');
                    fileToUpload = file;
                }
            }
            
            const totalChunks = Math.ceil(fileToUpload.size / CHUNK_SIZE);
            const startTime = Date.now();
            let uploadedBytes = startChunkIndex * CHUNK_SIZE;
            
            console.log('ÂàÜÂùó‰ø°ÊÅØ', { totalChunks, startChunkIndex, fileToUploadSize: fileToUpload.size });
            
            // ËøõÂ∫¶ÂõûË∞ÉÂáΩÊï∞
            const onProgress = (chunkUploadedBytes, totalBytes) => {
                uploadedBytes += chunkUploadedBytes;
                const progress = Math.min((uploadedBytes / totalBytes) * 100, 100);
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress.toFixed(1) + '%';
                
                // ËÆ°ÁÆó‰∏ä‰º†ÈÄüÂ∫¶
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                if (elapsedSeconds > 0) {
                    const speed = uploadedBytes / elapsedSeconds;
                    const remainingBytes = totalBytes - uploadedBytes;
                    const remainingSeconds = remainingBytes / speed;
                    
                    updateProgressText(
                        `Â∑≤‰∏ä‰º†: ${formatBytes(uploadedBytes)} / ${formatBytes(totalBytes)} ` +
                        `(${progress.toFixed(1)}%) | ` +
                        `ÈÄüÂ∫¶: ${formatBytes(speed)}/s | ` +
                        `Ââ©‰Ωô: ${formatTime(remainingSeconds)}`
                    );
                }
            };
            
            for (let i = startChunkIndex; i < totalChunks; i++) {
                console.log(`Ê≠£Âú®‰∏ä‰º†Âùó ${i + 1}/${totalChunks}`);
                
                if (isCancelled) {
                    throw new Error('‰∏ä‰º†Â∑≤ÂèñÊ∂à');
                }
                
                while (isPaused) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (isCancelled) {
                        throw new Error('‰∏ä‰º†Â∑≤ÂèñÊ∂à');
                    }
                }
                
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, fileToUpload.size);
                const chunk = fileToUpload.slice(start, end);
                
                console.log(`‰∏ä‰º†Âùó ${i}, Â§ßÂ∞è: ${chunk.size} Â≠óËäÇ`);
                
                // ‰º†ÈÄíÂéãÁº©ÂêéÁöÑÊñá‰ª∂Â§ßÂ∞èÁî®‰∫éËøõÂ∫¶ËÆ°ÁÆó
                await uploadChunk(file, fileToUpload, fileId, chunk, i, totalChunks, onProgress, shouldCompress);
                
                console.log(`Âùó ${i} ‰∏ä‰º†ÂÆåÊàê`);
            }
            
            // ‰∏ä‰º†ÂÆåÊàê
            updateProgressText('‰∏ä‰º†ÂÆåÊàê!');
            console.log('ÊâÄÊúâÂùó‰∏ä‰º†ÂÆåÊàê');
            setTimeout(() => {
                loadUploadedFiles();
                resetUploadUI();
                selectedFiles = [];
                updateFilePreview();
            }, 1000);
        }
        
        // Ë°®ÂçïÊèê‰∫§Â§ÑÁêÜ
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Ë°®ÂçïÊèê‰∫§Ë¢´Ëß¶Âèë');
            console.log('selectedFiles:', selectedFiles);
            
            if (selectedFiles.length === 0) {
                alert('ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰∏™Êñá‰ª∂');
                return;
            }
            
            // ÊöÇÊó∂Âè™ÊîØÊåÅÂçïÊñá‰ª∂Êñ≠ÁÇπÁª≠‰º†
            if (selectedFiles.length > 1) {
                alert('Êñ≠ÁÇπÁª≠‰º†ÂäüËÉΩÂΩìÂâç‰ªÖÊîØÊåÅÂçïÊñá‰ª∂‰∏ä‰º†ÔºåËØ∑ÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂');
                return;
            }
            
            const file = selectedFiles[0];
            const fileId = generateFileId(file);
            
            console.log('ÂáÜÂ§á‰∏ä‰º†Êñá‰ª∂:', file.name, 'fileId:', fileId);
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÈÉ®ÂàÜ‰∏ä‰º†
            const uploadedBytes = await checkUploadStatus(fileId);
            
            console.log('Â∑≤‰∏ä‰º†Â≠óËäÇÊï∞:', uploadedBytes);
            
            if (uploadedBytes > 0) {
                const confirmResume = confirm(`Ê£ÄÊµãÂà∞ËØ•Êñá‰ª∂Â∑≤‰∏ä‰º† ${formatBytes(uploadedBytes)}ÔºåÊòØÂê¶ÁªßÁª≠‰∏ä‰º†Ôºü`);
                if (confirmResume) {
                    currentUpload = { file, fileId };
                    await resumeUpload();
                    return;
                }
            }
            
            // ÂºÄÂßãÊñ∞ÁöÑ‰∏ä‰º†
            console.log('ÂºÄÂßãÊñ∞ÁöÑ‰∏ä‰º†');
            currentUpload = { file, fileId };
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‰∏ä‰º†‰∏≠...';
            cancelBtn.style.display = 'inline-block';
            
            try {
                await uploadFileInChunks(file, fileId, 0);
            } catch (error) {
                console.error('‰∏ä‰º†Â§±Ë¥•:', error);
                alert('‰∏ä‰º†Â§±Ë¥•: ' + error.message);
                resetUploadUI();
            }
        });
        
        // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
        resumeBtn.addEventListener('click', resumeUpload);
        cancelBtn.addEventListener('click', cancelUpload);
    </script>
</body>
</html>